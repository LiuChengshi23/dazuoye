<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›‘æ§å¤§å± - æœåŠ¡å™¨ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- å¼•å…¥å›¾è¡¨åº“ï¼ˆç”¨äºå±•ç¤ºCPU/å†…å­˜è¶‹åŠ¿ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å±€éƒ¨åŠ è½½åŠ¨ç”»ï¼ˆä¸å è¡¨æ ¼ç©ºé—´ï¼‰ */
        .inline-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #4cc9f0;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: inline-spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes inline-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* æ•°æ®æ›´æ–°å¹³æ»‘è¿‡æ¸¡ */
        .table td {
            transition: all 0.3s ease;
        }
        /* æ ¸å¿ƒï¼šæ•°æ®æ›´æ–°æ—¶çš„é—ªçƒåŠ¨ç”»ï¼ˆä»…ä½¿ç”¨ç‡ç­‰åŠ¨æ€æ•°æ®ï¼‰ */
        .data-update {
            animation: flash 0.5s ease-out;
        }
        @keyframes flash {
            0% { background-color: rgba(251, 191, 36, 0.2); } /* æµ…é»„è‰²é«˜äº®ï¼Œä¸åˆºçœ¼ */
            100% { background-color: transparent; }
        }
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ï¼ˆç¡®ä¿æ­£å¸¸æ˜¾ç¤ºï¼‰ */
        .status-online {
            color: #4ade80;
            font-weight: 500;
        }
        .status-offline {
            color: #f87171;
        }
        /* å‘Šè­¦æ ·å¼ */
        .alert-red {
            color: #ef4444; /* çº¢è‰²å‘Šè­¦è‰² */
            font-weight: bold;
        }
        .fa-exclamation-triangle {
            margin-left: 5px;
            color: #f59e0b; /* é»„è‰²è­¦å‘Šå›¾æ ‡ */
        }
        /* è¯­è¨€åˆ‡æ¢å™¨æ ·å¼ */
        .language-switcher-top {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .language-switcher-top select {
            padding: 8px 12px;
            background: rgba(13, 27, 42, 0.7);
            border: 1px solid #415a77;
            border-radius: 4px;
            color: #e0e1dd;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1 data-i18n="sidebar.system">æœåŠ¡å™¨ç³»ç»Ÿ</h1>
        </div>
        <div class="sidebar-nav">
            <a href="index.html" class="sidebar-nav-link">
                <div class="sidebar-item">
                    <i class="fas fa-server"></i>
                    <span data-i18n="sidebar.server_monitor">æœåŠ¡å™¨ç›‘æ§</span>
                </div>
            </a>
            <a href="dashboard.html" class="sidebar-nav-link">
                <div class="sidebar-item active">
                    <i class="fas fa-chart-pie"></i>
                    <span data-i18n="sidebar.dashboard">ç›‘æ§å¤§å±</span>
                </div>
            </a>
            <a href="index.html" class="sidebar-nav-link">
                <div class="sidebar-item">
                    <i class="fas fa-desktop"></i>
                    <span data-i18n="sidebar.host_management">ä¸»æœºç®¡ç†</span>
                </div>
            </a>
            <a href="history.html" class="sidebar-nav-link">
                <div class="sidebar-item">
                    <i class="fas fa-history"></i>
                    <span data-i18n="sidebar.history">å†å²è®°å½•</span>
                </div>
            </a>
            <a href="settings.html" class="sidebar-nav-link">
                <div class="sidebar-item">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="sidebar.settings">ç³»ç»Ÿè®¾ç½®</span>
                </div>
            </a>
        </div>
    </div>

    <!-- é¡¶éƒ¨è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher-top">
        <select id="languageSwitcherTop">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
        </select>
    </div>

    <div class="content">
        <div class="content-header">
            <h2 data-i18n="dashboard.title">ğŸ“Š ç›‘æ§å¤§å±</h2>
            <p class="subtitle" data-i18n="dashboard.subtitle">å®æ—¶ç›‘æ§æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€</p>
        </div>

        <!-- æœåŠ¡å™¨çŠ¶æ€æ¦‚è§ˆå¡ç‰‡ -->
        <div class="grid grid-3">
            <div class="card">
                <h3 data-i18n="dashboard.total_servers">æ€»æœåŠ¡å™¨æ•°</h3>
                <div style="font-size: 3em; font-weight: 300; color: #4cc9f0; margin: 20px 0;">
                    <span id="totalHosts">0</span> <span data-i18n="dashboard.unit_servers">å°</span>
                </div>
                <p style="color: #778da9;" data-i18n="dashboard.total_servers_desc">å·²æ·»åŠ çš„æœåŠ¡å™¨æ€»æ•°</p>
            </div>
            <div class="card">
                <h3 data-i18n="dashboard.running_normal">æ­£å¸¸è¿è¡Œ</h3>
                <div style="font-size: 3em; font-weight: 300; color: #4ade80; margin: 20px 0;">
                    <span id="onlineHosts">0</span> <span data-i18n="dashboard.unit_servers">å°</span>
                </div>
                <p style="color: #778da9;" data-i18n="dashboard.running_normal_desc">SSHè¿æ¥æ­£å¸¸çš„æœåŠ¡å™¨</p>
            </div>
            <div class="card">
                <h3 data-i18n="dashboard.avg_cpu_usage">å¹³å‡CPUä½¿ç”¨ç‡</h3>
                <div style="font-size: 3em; font-weight: 300; color: #fbbf24; margin: 20px 0;">
                    <span id="avgCpu">0.0</span>%
                </div>
                <p style="color: #778da9;" data-i18n="dashboard.avg_cpu_usage_desc">æ‰€æœ‰æœåŠ¡å™¨CPUå¹³å‡è´Ÿè½½</p>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸï¼ˆCPU/å†…å­˜è¶‹åŠ¿ï¼‰ -->
        <div class="grid grid-2">
            <div class="card">
                <h3 data-i18n="dashboard.cpu_trend">CPUä½¿ç”¨ç‡è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 data-i18n="dashboard.memory_trend">å†…å­˜ä½¿ç”¨ç‡è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="memChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æœåŠ¡å™¨è¯¦ç»†çŠ¶æ€è¡¨ï¼ˆä¼˜åŒ–åï¼šä»…æ•°æ®é—ªçƒï¼Œè¡¨æ ¼ä¸é—ªï¼‰ -->
        <div class="card">
            <h3 data-i18n="dashboard.server_status">æœåŠ¡å™¨è¯¦ç»†çŠ¶æ€</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="refreshDashboard()" class="btn btn-success" id="refreshStatusBtn">
                    ğŸ”„ <span data-i18n="host_management.refresh_data">åˆ·æ–°æ•°æ®</span>
                </button>
            </div>
            <div id="hostsStatusContainer">
                <!-- åˆå§‹åŠ è½½çŠ¶æ€ï¼ˆé¦–æ¬¡åŠ è½½æ˜¾ç¤ºï¼‰ -->
                <div id="initialLoading" style="text-align: center; padding: 40px; display: block;">
                    <div class="loading" style="margin: 0 auto;"></div>
                    <p style="margin-top: 15px; color: #778da9;" data-i18n="host_management.loading">åŠ è½½ä¸­...</p>
                </div>
                <!-- ç©ºçŠ¶æ€ï¼ˆæ— æ•°æ®æ—¶æ˜¾ç¤ºï¼‰ -->
                <div id="emptyStatus" style="text-align: center; padding: 40px; color: #778da9; display: none;">
                    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ–¥ï¸</div>
                    <p data-i18n="host_management.no_hosts">æš‚æ— æœåŠ¡å™¨æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ ä¸»æœº</p>
                </div>
                <!-- è¡¨æ ¼å®¹å™¨ï¼ˆæœ‰æ•°æ®æ—¶æ˜¾ç¤ºï¼Œè¡¨å¤´æ°¸ä¹…ä¿ç•™ï¼‰ -->
                <div id="tableWrapper" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th data-i18n="table.ip">IPåœ°å€</th>
                                <th data-i18n="table.username">ç”¨æˆ·å</th>
                                <th data-i18n="table.ssh_port">SSHç«¯å£</th>
                                <th data-i18n="table.cpu_usage">CPUä½¿ç”¨ç‡</th>
                                <th data-i18n="table.memory_usage">å†…å­˜ä½¿ç”¨ç‡</th>
                                <th data-i18n="table.disk_usage">ç£ç›˜ä½¿ç”¨ç‡</th>
                                <th data-i18n="table.status">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody">
                            <!-- æ•°æ®è¡ŒåŠ¨æ€æ›´æ–°ï¼Œä»…å•å…ƒæ ¼å†…å®¹å˜åŒ– -->
                        </tbody>
                    </table>
                </div>
                <!-- é”™è¯¯æç¤ºå®¹å™¨ -->
                <div id="errorStatus" style="display: none;" class="alert alert-danger"></div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è¯­è¨€åŒ…å¼•ç”¨ -->
    <script src="js/i18n/zh.js"></script>
    <script src="js/i18n/en.js"></script>
    <script src="js/i18n/index.js"></script>

    <!-- åŠ è½½UIå·¥å…·åº“å’Œå›¾è¡¨ç®¡ç† -->
    <script src="js/ui.js"></script>
    <script src="js/charts.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let cpuChart = null;
        let memChart = null;
        const API_BASE = 'http://192.168.80.131:5000/api';
        const chartData = {
            labels: [], // æ—¶é—´è½´æ ‡ç­¾
            cpuData: {}, // å„ä¸»æœºCPUæ•°æ®
            memData: {}  // å„ä¸»æœºå†…å­˜æ•°æ®
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ç›‘æ§å¤§å±é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–å›½é™…åŒ–
            if (window.i18nManager) {
                console.log('ğŸŒ åˆå§‹åŒ–å›½é™…åŒ–ç®¡ç†å™¨');
                window.i18nManager.applyLanguage();
                // è®¾ç½®è¯­è¨€åˆ‡æ¢å™¨å½“å‰å€¼
                document.getElementById('languageSwitcherTop').value = window.i18nManager.getCurrentLanguage();
            }
            
            // æ·»åŠ è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('languageSwitcherTop').addEventListener('change', function() {
                if (window.switchLanguage) {
                    window.switchLanguage(this.value);
                }
            });
            
            // ä¿®å¤ä¾§è¾¹æ é«˜äº®ï¼ˆä¸é‡æ–°åŠ è½½æ•´ä¸ªä¾§è¾¹æ ï¼‰
            if (window.fixSidebarHighlight) {
                window.fixSidebarHighlight();
            }
            
            console.log('âœ… ä¾§è¾¹æ ä¿®å¤å®Œæˆ');
            
            // å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                initCharts();  // åˆå§‹åŒ–å›¾è¡¨
                refreshDashboard(); // åŠ è½½åˆå§‹æ•°æ®
            }, 100);
            
            // è‡ªåŠ¨åˆ·æ–°ï¼ˆ5ç§’ä¸€æ¬¡ï¼‰
            setInterval(refreshDashboard, 5000);
            console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å·²å¯åŠ¨');
        });

        /**
         * åˆå§‹åŒ–å›¾è¡¨ - ä½¿ç”¨å®‰å…¨çš„åˆå§‹åŒ–æ–¹å¼
         */
        function initCharts() {
            console.log('ğŸ“Š å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
            
            try {
                // åˆå§‹åŒ–CPUå›¾è¡¨
                const cpuCanvas = document.getElementById('cpuChart');
                if (cpuCanvas) {
                    const cpuCtx = cpuCanvas.getContext('2d');
                    cpuChart = new Chart(cpuCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: true,
                                    labels: { color: '#e0e1dd' }
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    grid: { color: 'rgba(65, 90, 119, 0.3)' },
                                    ticks: { color: '#a8b5c5' }
                                },
                                y: {
                                    display: true,
                                    min: 0,
                                    max: 100,
                                    grid: { color: 'rgba(65, 90, 119, 0.3)' },
                                    ticks: { 
                                        color: '#a8b5c5', 
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('âœ… CPUå›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ CPUå›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                }

                // åˆå§‹åŒ–å†…å­˜å›¾è¡¨
                const memCanvas = document.getElementById('memChart');
                if (memCanvas) {
                    const memCtx = memCanvas.getContext('2d');
                    memChart = new Chart(memCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: true,
                                    labels: { color: '#e0e1dd' }
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    grid: { color: 'rgba(65, 90, 119, 0.3)' },
                                    ticks: { color: '#a8b5c5' }
                                },
                                y: {
                                    display: true,
                                    min: 0,
                                    max: 100,
                                    grid: { color: 'rgba(65, 90, 119, 0.3)' },
                                    ticks: { 
                                        color: '#a8b5c5',
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('âœ… å†…å­˜å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ å†…å­˜å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                }
                
                console.log('âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        /**
         * åˆ·æ–°ç›‘æ§å¤§å±æ•°æ®
         */
        async function refreshDashboard() {
            console.log('ğŸ”„ å¼€å§‹åˆ·æ–°ç›‘æ§æ•°æ®...');
            
            const refreshBtn = document.getElementById('refreshStatusBtn');
            const initialLoading = document.getElementById('initialLoading');
            const emptyStatus = document.getElementById('emptyStatus');
            const tableWrapper = document.getElementById('tableWrapper');
            const statusTableBody = document.getElementById('statusTableBody');
            const errorStatus = document.getElementById('errorStatus');

            // åˆ·æ–°æŒ‰é’®çŠ¶æ€å¤„ç†
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<div class="inline-loading"></div> <span data-i18n="host_management.refreshing">åˆ·æ–°ä¸­...</span>';

            // éšè—æ‰€æœ‰çŠ¶æ€å®¹å™¨ï¼ŒæŒ‰éœ€æ˜¾ç¤º
            initialLoading.style.display = 'none';
            emptyStatus.style.display = 'none';
            errorStatus.style.display = 'none';

            try {
                console.log('ğŸ“¡ è¯·æ±‚ä¸»æœºæ•°æ®...');
                // è·å–æœ€æ–°ä¸»æœºæ•°æ®
                const response = await fetch(`${API_BASE}/hosts`);
                if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
                const hosts = await response.json();
                console.log('âœ… è·å–åˆ°ä¸»æœºæ•°æ®:', hosts);

                // è·å–å‘Šè­¦é˜ˆå€¼
                const settingsResp = await fetch(`${API_BASE}/settings`);
                const settings = await settingsResp.json();
                const cpuThreshold = settings.cpu_threshold;
                const memThreshold = settings.mem_threshold;

                // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
                updateOverviewStats(hosts);

                // æ›´æ–°å›¾è¡¨æ•°æ®
                updateChartsData(hosts);

                // æ›´æ–°æœåŠ¡å™¨è¯¦ç»†çŠ¶æ€è¡¨
                if (!hosts || hosts.length === 0) {
                    // æ— æ•°æ®ï¼šæ˜¾ç¤ºç©ºçŠ¶æ€
                    emptyStatus.style.display = 'block';
                    tableWrapper.style.display = 'none';
                    console.log('â„¹ï¸ æ— ä¸»æœºæ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                } else {
                    // æœ‰æ•°æ®ï¼šæ˜¾ç¤ºè¡¨æ ¼ï¼Œéšè—å…¶ä»–çŠ¶æ€
                    tableWrapper.style.display = 'block';
                    emptyStatus.style.display = 'none';

                    // 1. æ„å»ºä¸»æœºIPæ˜ å°„ï¼ˆæ–¹ä¾¿å¿«é€ŸæŸ¥è¯¢ï¼‰
                    const hostIpMap = new Map();
                    hosts.forEach(host => hostIpMap.set(host.ip, host));

                    // 2. è·å–ç°æœ‰è¡¨æ ¼è¡Œï¼Œæ›´æ–°å·²æœ‰ä¸»æœºçš„æ•°æ®ï¼ˆä»…åŠ¨æ€å­—æ®µï¼‰
                    const existingRows = statusTableBody.querySelectorAll('tr');
                    const existingIps = new Set();

                    existingRows.forEach(row => {
                        const ip = row.cells[0].textContent.trim(); // ä»IPå•å…ƒæ ¼è·å–å”¯ä¸€æ ‡è¯†
                        const host = hostIpMap.get(ip);
                        if (host) {
                            existingIps.add(ip);

                            // è§£æä½¿ç”¨ç‡æ•°å€¼
                            const cpu = parseFloat(host.cpu.replace('%', ''));
                            const mem = parseFloat(host.mem.replace('%', ''));
                            const cpuAlert = cpu > cpuThreshold;
                            const memAlert = mem > memThreshold;

                            // æ›´æ–°CPUä½¿ç”¨ç‡
                            const cpuCell = row.cells[3];
                            if (cpuCell.textContent !== host.cpu) {
                                cpuCell.textContent = host.cpu;
                                cpuCell.className = cpuAlert ? 'alert-red' : '';
                                cpuCell.innerHTML = `${host.cpu} ${cpuAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}`;
                                cpuCell.classList.add('data-update');
                                setTimeout(() => cpuCell.classList.remove('data-update'), 500);
                            } else {
                                cpuCell.className = cpuAlert ? 'alert-red' : '';
                                cpuCell.innerHTML = `${host.cpu} ${cpuAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}`;
                            }

                            // æ›´æ–°å†…å­˜ä½¿ç”¨ç‡
                            const memCell = row.cells[4];
                            if (memCell.textContent !== host.mem) {
                                memCell.textContent = host.mem;
                                memCell.className = memAlert ? 'alert-red' : '';
                                memCell.innerHTML = `${host.mem} ${memAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}`;
                                memCell.classList.add('data-update');
                                setTimeout(() => memCell.classList.remove('data-update'), 500);
                            } else {
                                memCell.className = memAlert ? 'alert-red' : '';
                                memCell.innerHTML = `${host.mem} ${memAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}`;
                            }

                            // ç£ç›˜ä½¿ç”¨ç‡
                            const diskCell = row.cells[5];
                            const newDisk = host.disk || '0.0%';
                            if (diskCell.textContent !== newDisk) {
                                diskCell.textContent = newDisk;
                                diskCell.classList.add('data-update');
                                setTimeout(() => diskCell.classList.remove('data-update'), 500);
                            }

                            // åœ¨çº¿çŠ¶æ€
                            const statusCell = row.cells[6];
                            const isOnline = cpu > 0 || mem > 0;
                            const newStatusText = isOnline ? 
                                (window.i18nManager ? window.i18nManager.t('status.online') : 'åœ¨çº¿') : 
                                (window.i18nManager ? window.i18nManager.t('status.offline') : 'ç¦»çº¿');
                            const newStatusClass = isOnline ? 'status-online' : 'status-offline';
                            
                            if (statusCell.textContent !== newStatusText) {
                                statusCell.textContent = newStatusText;
                                statusCell.className = newStatusClass;
                                statusCell.classList.add('data-update');
                                setTimeout(() => statusCell.classList.remove('data-update'), 500);
                            }
                        }
                    });

                    // 3. æ·»åŠ æ–°ä¸»æœºè¡Œï¼ˆé¦–æ¬¡å‡ºç°çš„ä¸»æœºï¼‰
                    hosts.forEach(host => {
                        const ip = host.ip;
                        if (!existingIps.has(ip)) {
                            const cpu = parseFloat(host.cpu) || 0;
                            const mem = parseFloat(host.mem) || 0;
                            const isOnline = cpu > 0 || mem > 0;
                            const statusClass = isOnline ? 'status-online' : 'status-offline';
                            const statusText = isOnline ? 
                                (window.i18nManager ? window.i18nManager.t('status.online') : 'åœ¨çº¿') : 
                                (window.i18nManager ? window.i18nManager.t('status.offline') : 'ç¦»çº¿');
                            const cpuAlert = cpu > cpuThreshold;
                            const memAlert = mem > memThreshold;

                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
                                <td>${host.ip}</td>
                                <td>${host.username}</td>
                                <td>${host.port || 22}</td>
                                <td class="${cpuAlert ? 'alert-red' : ''}">
                                    ${host.cpu} ${cpuAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                                </td>
                                <td class="${memAlert ? 'alert-red' : ''}">
                                    ${host.mem} ${memAlert ? '<i class="fas fa-exclamation-triangle"></i>' : ''}
                                </td>
                                <td>${host.disk || '0.0%'}</td>
                                <td class="${statusClass}">${statusText}</td>
                            `;
                            statusTableBody.appendChild(newRow);
                        }
                    });

                    // 4. ç§»é™¤å·²åˆ é™¤çš„ä¸»æœºè¡Œ
                    existingRows.forEach(row => {
                        const ip = row.cells[0].textContent.trim();
                        if (!hostIpMap.has(ip)) {
                            row.remove();
                        }
                    });
                    
                    console.log('âœ… è¡¨æ ¼æ•°æ®æ›´æ–°å®Œæˆ');
                }

            } catch (error) {
                console.error('âŒ åˆ·æ–°ç›‘æ§å¤§å±å¤±è´¥:', error);
                // é”™è¯¯çŠ¶æ€ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
                errorStatus.style.display = 'block';
                errorStatus.innerHTML = `âŒ åŠ è½½æ•°æ®å¤±è´¥ï¼š${error.message}`;
                // è‹¥å·²æœ‰è¡¨æ ¼ï¼Œä¿ç•™è¡¨æ ¼æ¡†æ¶
                if (statusTableBody.querySelectorAll('tr').length > 0) {
                    tableWrapper.style.display = 'block';
                }
            } finally {
                // æ¢å¤åˆ·æ–°æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'ğŸ”„ <span data-i18n="host_management.refresh_data">åˆ·æ–°æ•°æ®</span>';
                
                // é‡æ–°åº”ç”¨è¯­è¨€
                if (window.i18nManager) {
                    window.i18nManager.applyLanguage();
                }
                
                console.log('âœ… æ•°æ®åˆ·æ–°å®Œæˆ');
            }
        }

        /**
         * æ›´æ–°æ¦‚è§ˆç»Ÿè®¡æ•°æ®
         */
        function updateOverviewStats(hosts) {
            const totalHosts = hosts.length;
            const onlineHosts = hosts.filter(host => {
                const cpu = parseFloat(host.cpu) || 0;
                const mem = parseFloat(host.mem) || 0;
                return cpu > 0 || mem > 0;
            }).length;

            const totalCpu = hosts.reduce((sum, host) => {
                return sum + (parseFloat(host.cpu) || 0);
            }, 0);
            const avgCpu = totalHosts > 0 ? (totalCpu / totalHosts).toFixed(1) : '0.0';

            document.getElementById('totalHosts').textContent = totalHosts;
            document.getElementById('onlineHosts').textContent = onlineHosts;
            document.getElementById('avgCpu').textContent = avgCpu;
            
            console.log(`ğŸ“Š æ¦‚è§ˆç»Ÿè®¡: æ€»æ•°=${totalHosts}, åœ¨çº¿=${onlineHosts}, å¹³å‡CPU=${avgCpu}%`);
        }

        /**
         * æ›´æ–°å›¾è¡¨æ•°æ®
         */
        function updateChartsData(hosts) {
            console.log('ğŸ“ˆ å¼€å§‹æ›´æ–°å›¾è¡¨æ•°æ®...');
            
            if (!cpuChart || !memChart) {
                console.warn('âš ï¸ å›¾è¡¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }

            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // ç¡®ä¿labelsæ•°ç»„å­˜åœ¨
            if (!chartData.labels) chartData.labels = [];
            if (!chartData.cpuData) chartData.cpuData = {};
            if (!chartData.memData) chartData.memData = {};

            // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
            if (chartData.labels.length > 10) {
                chartData.labels.shift();
            }
            chartData.labels.push(now);

            // å¤„ç†æ¯ä¸ªä¸»æœºçš„æ•°æ®
            hosts.forEach(host => {
                const ip = host.ip;
                
                // åˆå§‹åŒ–æ•°æ®æ•°ç»„
                if (!chartData.cpuData[ip]) {
                    chartData.cpuData[ip] = [];
                }
                if (!chartData.memData[ip]) {
                    chartData.memData[ip] = [];
                }

                // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
                if (chartData.cpuData[ip].length > 10) {
                    chartData.cpuData[ip].shift();
                }
                if (chartData.memData[ip].length > 10) {
                    chartData.memData[ip].shift();
                }

                // æ·»åŠ æ–°æ•°æ®ï¼ˆç¡®ä¿æ˜¯æ•°å­—ï¼‰
                const cpuValue = parseFloat(host.cpu) || 0;
                const memValue = parseFloat(host.mem) || 0;
                
                chartData.cpuData[ip].push(cpuValue);
                chartData.memData[ip].push(memValue);
            });

            const colors = [
                '#4361ee', '#4cc9f0', '#f72585', '#b5179e', '#7209b7',
                '#3a0ca3', '#4ade80', '#fbbf24', '#f87171', '#94a3b8'
            ];

            try {
                // æ›´æ–°CPUå›¾è¡¨
                cpuChart.data.labels = [...chartData.labels];
                cpuChart.data.datasets = Object.entries(chartData.cpuData).map(([ip, data], index) => ({
                    label: ip,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: `${colors[index % colors.length]}20`,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false
                }));
                cpuChart.update();
                console.log('âœ… CPUå›¾è¡¨æ›´æ–°å®Œæˆ');

                // æ›´æ–°å†…å­˜å›¾è¡¨
                memChart.data.labels = [...chartData.labels];
                memChart.data.datasets = Object.entries(chartData.memData).map(([ip, data], index) => ({
                    label: ip,
                    data: data,
                    borderColor: colors[(index + 3) % colors.length],
                    backgroundColor: `${colors[(index + 3) % colors.length]}20`,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false
                }));
                memChart.update();
                console.log('âœ… å†…å­˜å›¾è¡¨æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('âŒ æ›´æ–°å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>